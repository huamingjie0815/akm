# Design: Add Interactive Prompts for akm add

## Context

当前 `akm add` 命令要求用户通过命令行参数提供所有必需信息（name、provider、base-url、api-key），这在交互式使用时不够友好。本设计旨在为 `akm add` 添加交互式提示功能，当缺少必需参数时，自动引导用户逐步输入必要信息。

**当前状态**:
- `akm add` 已实现基本功能，支持通过命令行参数创建 profile
- 已安装 `@inquirer/prompts` 依赖，可用于交互式提示
- CLI 框架使用 Commander，支持命令选项解析

**约束**:
- 保持向后兼容，原有命令行参数方式必须继续可用
- 交互式模式仅在缺少必需参数时触发
- 需要支持通过 `--interactive` 强制进入交互式模式

## Goals / Non-Goals

**Goals:**
- 实现 `akm add` 的交互式提示功能，分步骤引导用户输入必需参数
- 支持输入验证和错误提示，确保数据格式正确
- 提供可选参数的提示，但允许用户跳过
- 在所有输入完成后显示摘要，供用户确认
- 保持完全向后兼容，原有命令行方式继续可用

**Non-Goals:**
- 不为 `akm update` 添加交互式提示（可作为未来增强）
- 不实现复杂的表单验证（如 URL 可达性检查）
- 不支持多语言界面
- 不添加图形界面（保持纯 CLI）

## Decisions

### 1. 使用 @inquirer/prompts 而非 inquirer

**选择**: 使用 `@inquirer/prompts` 包实现交互式提示

**理由**:
- `@inquirer/prompts` 是 inquirer 的官方现代化替代品
- 更好的 TypeScript 支持，类型定义更完善
- 更小的包体积，更快的加载速度
- 支持 ESM 和 CommonJS

**替代方案**:
- `inquirer`: 功能更丰富但包体积更大，TypeScript 支持较弱
- `prompts`: 轻量级但功能相对简单

### 2. 交互式触发策略

**选择**: 仅在缺少任一必需参数时自动进入交互式模式

**策略**:
1. 解析命令行参数
2. 检查必需参数是否完整（name, provider, base-url, api-key）
3. 如果缺少任何必需参数，进入交互式提示
4. 如果提供了 `--interactive` 标志，强制进入交互式模式
5. 如果所有必需参数都已提供，使用非交互式模式

**理由**:
- 向后兼容：原有脚本和命令行使用方式不受影响
- 用户体验：新用户自动获得引导，老用户习惯不变
- 灵活性：`--interactive` 允许强制进入交互模式

### 3. 提示顺序和验证策略

**选择**: 按固定顺序提示，每个输入后即时验证

**提示顺序**:
1. Profile name (必需)
2. Provider (必需，提供常见选项)
3. Base URL (必需，根据 provider 提供默认值)
4. API Key (必需，输入时隐藏)
5. Model name (可选，根据 provider 提供建议)
6. 确认摘要

**验证策略**:
- name: 非空，唯一性检查
- provider: 非空，支持常见值或自定义
- base-url: 有效 URL 格式
- api-key: 非空
- model: 可选，格式验证

**理由**:
- 逻辑顺序：从标识到配置，再到可选设置
- 即时验证：及早发现问题，减少用户重复工作
- 默认值：根据 provider 智能提供默认值，减少输入

### 4. 错误处理和用户体验

**选择**: 提供清晰的错误信息，支持重试和退出

**策略**:
- 验证失败时显示具体错误信息（如 "Profile name 'test' already exists"）
- 允许用户重新输入（重试）
- 支持 Ctrl+C 退出，清理状态
- 在摘要阶段允许返回修改特定字段

**理由**:
- 用户友好：清晰的错误帮助用户快速纠正
- 容错性：允许重试而非强制重新开始
- 控制权：用户始终可以退出，不会陷入死循环

## Risks / Trade-offs

**[风险] 向后兼容性问题** → **缓解**: 交互式模式仅在缺少必需参数时触发，原有命令行方式完全保留。添加 `--interactive` 标志允许强制进入交互模式，但不影响现有行为。

**[风险] 依赖包体积增加** → **缓解**: `@inquirer/prompts` 相比 `inquirer` 更轻量，且仅在实际使用时加载。交互式模式只在缺少参数时触发，对非交互式使用无影响。

**[风险] 终端兼容性问题** → **缓解**: `@inquirer/prompts` 支持大多数现代终端，但某些 CI/CD 环境或非 TTY 环境可能不支持交互式输入。在这些环境中，应通过命令行参数提供所有必需值，避免进入交互式模式。

**[风险] 输入验证复杂性** → **缓解**: 采用渐进式验证策略，每个字段单独验证，避免一次性验证所有字段的复杂性。对于复杂验证（如 URL 可达性），留待未来版本实现，当前仅验证格式。

**[权衡] 用户体验 vs 简单性** → 选择提供引导式交互体验，略微增加代码复杂性，但显著提升用户体验，特别是对新手用户。

**[权衡] 功能丰富度 vs 维护成本** → 选择实现核心交互功能，避免过度设计。未来可根据用户反馈逐步增强，如添加更多字段类型、自定义验证规则等。

## Migration Plan

**开发阶段**:
1. 在本地分支开发交互式提示功能
2. 添加 `@inquirer/prompts` 依赖
3. 实现 `akm add` 的交互式模式
4. 编写单元测试和集成测试
5. 在本地进行全面测试

**发布阶段**:
1. 发布新版本（patch 或 minor 版本，视向后兼容性而定）
2. 更新 README 文档，添加交互式使用示例
3. 发布 changelog，说明新功能

**用户迁移**:
- 用户通过 `npm update -g apikey-manage` 更新到最新版本
- 现有脚本和命令行使用方式无需任何更改
- 新用户可以享受到更友好的交互式体验

## Open Questions

1. **是否需要在交互式模式下支持默认值？**
   - 例如：当用户选择 provider 为 "openai" 时，自动建议 base-url 为 "https://api.openai.com"
   - 这可以减少用户输入，但可能不够灵活

2. **如何处理敏感信息（API Key）的输入？**
   - 是否需要二次确认？
   - 是否允许从环境变量或文件读取？
   - 输入时是否需要特殊的安全提示？

3. **是否需要支持配置文件批量导入？**
   - 用户可能有多个 profile 需要添加
   - 是否支持从 JSON 或 YAML 文件批量导入？
   - 这超出了当前 scope，但值得考虑作为未来增强

4. **交互式提示的样式和主题是否需要可配置？**
   - 颜色、符号、提示文本是否需要支持国际化？
   - 是否需要支持自定义主题？
   - 当前 scope 保持简单，使用默认主题

5. **错误处理策略是否需要更详细的定义？**
   - 当输入验证失败时，允许多少次重试？
   - 是否需要在特定错误次数后退出？
   - 如何优雅地处理意外错误（如文件系统错误）？

